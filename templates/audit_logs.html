{% extends "base.html" %}
{% block title %}Audit Logs - Savings & Loan{% endblock %}
{% block content %}
<div class="bg-gray-100 min-h-screen">
    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold">Audit Logs</h2>
            <a href="{{ url_for('dashboard') }}" class="inline-block mt-2 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Back to Dashboard</a>
        </div>

        <!-- Audit Logs -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-xl font-semibold mb-4">Transaction History</h3>
            <form method="POST" action="{{ url_for('audit_logs') }}" class="mb-4">
                <button type="submit" name="export_audit" value="csv" class="inline-block px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Download as CSV</button>
            </form>
            {% if transactions %}
                <div class="overflow-x-auto">
                    <table id="audit-table" class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border border-gray-300 p-2">Transaction ID</th>
                                <th class="border border-gray-300 p-2">Type</th>
                                <th class="border border-gray-300 p-2">Customer</th>
                                <th class="border border-gray-300 p-2">Amount</th>
                                <th class="border border-gray-300 p-2">Details</th>
                                <th class="border border-gray-300 p-2">Created By</th>
                                <th class="border border-gray-300 p-2">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                                <tr class="hover:bg-gray-50">
                                    <td class="border border-gray-300 p-2">{{ transaction.id }}</td>
                                    <td class="border border-gray-300 p-2">{{ transaction.type | capitalize }}</td>
                                    <td class="border border-gray-300 p-2">{{ transaction.customer_name }}</td>
                                    <td class="border border-gray-300 p-2">{{ transaction.amount | round(2) if transaction.amount is not none else 'N/A' }}</td>
                                    <td class="border border-gray-300 p-2">{{ transaction.details or 'N/A' }}</td>
                                    <td class="border border-gray-300 p-2">{{ transaction.created_by }}</td>
                                    <td class="border border-gray-300 p-2">{{ transaction.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-gray-600">No audit logs available.</p>
            {% endif %}
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script>
    const socket = io();
    socket.on('new_transaction', function(data) {
        const table = document.getElementById('audit-table').getElementsByTagName('tbody')[0];
        const row = table.insertRow(0);
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="border border-gray-300 p-2">${data.id}</td>
            <td class="border border-gray-300 p-2">${data.type}</td>
            <td class="border border-gray-300 p-2">${data.customer_name}</td>
            <td class="border border-gray-300 p-2">${data.amount}</td>
            <td class="border border-gray-300 p-2">${data.details}</td>
            <td class="border border-gray-300 p-2">${data.created_by}</td>
            <td class="border border-gray-300 p-2">${data.created_at}</td>
        `;
    });
</script>
{% endblock %}